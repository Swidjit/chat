#chatbox
%button#startBtn{:onclick => "start()"}
  =image_tag 'mic.png'
%button#stopBtn{:onclick => "stop()"}
  off
%input#chat{:type=>'text', :placeholder => 'talk'}
#comment
#search-result
%br
#message
%button#send{:onclick => "send()"} send

:javascript
  var client;

  if (client) {
      stop();
  }

  client = new BingSpeech.RecognitionClient("f80517976240427d895b013aafe46ab9");

  client.onFinalResponseReceived = function (response) {
      response = response.replace(/[^a-zA-Z 0-9]+/g, '').toLowerCase();
      $.post('/check-validity', {q:response}, function(data) {
        if(data["success"] == true) {
          phrase += response + ' ';
          $('#comment').append('<div class="chunk">'+ response +'</chunk>');
          $('#chat').val('');
          $('#chat').focus();
          $('#chat').css('color','green');
          $('#search-result').empty();
          $('#send').show();
        }
        else {
          $('#message').html('Invalid text: ' + response);
        }
      });
  }

  client.onError = function (code, requestId) {
      console.log("<Error with request nÂ°" + requestId + ">");
  }

  function send() {
    phrase = '';
    $('#comment .chunk').each(function() {
      str = $(this).text();
      phrase += str + ' ';
    });
    phrase = phrase.trim();

    $('#chatbox').prepend('<div class="phrase">'+phrase+'</phrase>');
    $('#comment').empty();
    phrase = '';
    $('#send').hide();
  }

  function start() {
      $("#startBtn").hide();
      $("#stopBtn").show();
      client.startMicAndContinuousRecognition();
  }

  function stop() {
      $("#stopBtn").hide();
      $("#startBtn").show();
      client.endMicAndContinuousRecognition();
  }

:javascript
  $('#chat').focus();
  var phrase = ''
  var entries = [];

  jQuery(function(){
      jQuery('input#chat')
        .data('timeout', null)
        .keyup(function(){
            clearTimeout(jQuery(this).data('timeout'));
            jQuery(this).data('timeout', setTimeout(function(){
             if($("input#chat").val().length > 2) {
              q = $("input#chat").val().trim();
               $.post('/chat', { q: q}, function(data) {
                  Jaml.register('choice', function(choice) {
                    div({cls: "choice"},
                      span(choice.str)
                    );
                  });
                  if(data.length > 0){
                     $("#search-result").html("");
                     $(data).each(function(idx, d){
                        console.log(d);
                       $("#search-result").append(Jaml.render('choice',d));
                       $('#search-result').css('display','block');
                     })
                   }else{
                     $("#search-result").html("<p>No suggestions found.</p>")
                   }

               }, "json");
             }
             else {
               $('#search-result').css('display','none');
             }
            //timeout function

            }, 500));
        });
    });

    $(document).on('click','.choice',function() {

      phrase += $(this).text().trim() + ' ';
      $('#comment').append('<div class="chunk">'+ $(this).text().trim() +'</chunk>');
      $('#chat').val('');
      $('#chat').focus();
      $('#chat').css('color','green');
      $('#search-result').empty();
      entries.push($(this).text().trim());
      $('#send').show();
    });
    $(document).on('click','.chunk',function() {

      $(this).remove();
    });

  $(window).keydown(function (e) {
    if (e.keyCode === 8 && $('#chat').val() == '') {
      $('#comment').children().last().remove();
    }
    if (e.keyCode === 0 || e.keyCode === 32 || e.keyCode === 8) {
      $.post('/check-validity', {q:$('#chat').val()}, function(data) {
        if(data["success"] == true) {
          if(data["mode"] == 'exact') {
            txt = $('#chat').val();
            word = txt.split(' ')[0];
            phrase += word + ' ';
            $('#comment').append('<div class="chunk">'+ word +'</chunk>');
            remainder= txt.split(' ')[1];
            $('#chat').val(remainder);          }
          else {
          }

          $('#chat').css('color','green');
          $('#send').show();
        }
        else {
          $('#chat').css('color','red');
          $('#send').hide();
        }
      });
    }
  });
