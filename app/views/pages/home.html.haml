
:css

  #speechActivity {
      position: absolute;
      width: 30px;
  }

  #networkActivity {
      position: absolute;
      width: 30px;
      top: 40px;
  }

  .hidden {
      display: none;
  }
  .choice {
    padding: 0px 5px;
  }
  .choice:hover {
    background: blue;
    color: white;
  }

  .chunk {
    margin: 3px 5px;
    padding: 4px 6px;
    display: inline;
  }

  #chatbox {
    text-align: right;
  }
  #comment {
    float:right;
    text-align: right;
    font-size: 1.6em;
    margin-top: 12px;
  }
  #chat {
    width: 300px;
    margin-right: 60px;
    float: right;
    margin-top: 10px;
  }

  #stopBtn {
    display:none;
  }
  #stopBtn, #startBtn {
    margin-top: 10px;
    position: absolute;
    top: 0px;
    right: 0px;
  }
  #message {
    color:red;
  }
  input#chat, input#chat:focus {
    border: none;
    outline: none;
    font-size: 1.5em;
  }
  #search-result {
    position: absolute;
    top: 60px;
    right: 175px;
    font-size: 1.5em;
    text-align: left;
  }
  #send {
    display: none;
    background-color: green;
    color: white;
    padding: 4px 6px;
    position: absolute;
    top: 75px;
    right: 5px;
    font-weight: 600;
    font-size: 1.5em;
  }

%button#startBtn{:onclick => "start()"}
  =image_tag 'mic.png'
%button#stopBtn{:onclick => "stop()"}
  off
%input#chat{:type=>'text', :placeholder => 'talk'}
  #search-result
#comment
#message
%button#send send
:javascript
  var client;

  if (client) {
      stop();
  }

  client = new BingSpeech.RecognitionClient("f80517976240427d895b013aafe46ab9");

  client.onFinalResponseReceived = function (response) {
      response = response.replace(/[^a-zA-Z 0-9]+/g, '').toLowerCase();
      $.post('/check-validity', {q:response}, function(data) {
        if(data["success"] == true) {
          console.log('valid');
          console.log(response);
          console.log(phrase);
          phrase += response + ' ';
          console.log(phrase);
          $('#comment').html('<div class="chunk">'+ phrase +'</chunk>');
          $('#chat').val('');
          $('#chat').focus();
          $('#chat').css('color','green');
          $('#search-result').empty();
          entries.push(response);
          $('#send').show();
        }
        else {
          $('#message').html('Invalid text: ' + response);
        }
      });
  }

  client.onError = function (code, requestId) {
      console.log("<Error with request nÂ°" + requestId + ">");
  }

  function start() {
      $("#startBtn").hide();
      $("#stopBtn").show();
      client.startMicAndContinuousRecognition();
  }

  function stop() {
      $("#stopBtn").hide();
      $("#startBtn").show();
      client.endMicAndContinuousRecognition();
  }

:javascript
  $('#chat').focus();
  var phrase = ''
  var entries = [];

  jQuery(function(){
      jQuery('input#chat')
        .data('timeout', null)
        .keyup(function(){
            clearTimeout(jQuery(this).data('timeout'));
            jQuery(this).data('timeout', setTimeout(function(){
             if($("input#chat").val().length > 2) {
              q = $("input#chat").val().trim();
               $.post('/chat', { q: q}, function(data) {
                  Jaml.register('choice', function(choice) {
                    div({cls: "choice"},
                      p(phrase + choice.str)
                    );
                  });
                  if(data.length > 0){
                     $("#search-result").html("");
                     $(data).each(function(idx, d){
                        console.log(d);
                       $("#search-result").append(Jaml.render('choice',d));
                       $('#search-result').css('display','block');
                     })
                   }else{
                     $("#search-result").html("<p>No suggestions found.</p>")
                   }

               }, "json");
             }
             else {
               $('#search-result').css('display','none');
             }
            //timeout function

            }, 500));
        });
    });

    $(document).on('click','.choice',function() {

      phrase = $(this).text().trim() + ' ';
      $('#comment').html('<div class="chunk">'+ phrase +'</chunk>');
      $('#chat').val('');
      $('#chat').focus();
      $('#chat').css('color','green');
      $('#search-result').empty();
      entries.push($(this).text().trim());
      $('#send').show();
    });

  $(window).keydown(function (e) {
    if (e.keyCode === 8 && $('#chat').val() == '') {
      console.log('empty');
      txt = entries.pop();
      console.log(txt);
      console.log($('#comment').first().text().split(txt)[0]);
    }
    if (e.keyCode === 0 || e.keyCode === 32 || e.keyCode === 8) {
      $.post('/check-validity', {q:phrase+' '+$('#chat').val()}, function(data) {
        if(data["success"] == true) {
          $('#chat').css('color','green');
          $('#send').show();
        }
        else {
          $('#chat').css('color','red');
          $('#send').hide();
        }
      });
    }
  });
